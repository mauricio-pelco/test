<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="DDI Gadget 2.2"
  description="Attempting to create a standalone JQL gadget" 
  author="Mauricio Munoz" 
  author_email="mauricio.pelco@gmail.com">
	<Require feature="dynamic-height"/>
    <Optional feature="gadget-directory">
      <Param name="categories">JIRA</Param>
    </Optional>
  </ModulePrefs>
  <Content type="html">
    <![CDATA[
	
		<div id="main" class="centered" style="display: none">
			
		</div>
			
		<div id="drop-down" class="column-picker-select-wrapper">
			<select id="column-picker-select" class="select">
				<option value="">Select a field...</option>
				<option value="">Option 1</option>
			</select>
			<input id="column-picker-add" type="button" value="Add" class="button">
		</div>
		
		<style type="text/css"> 
			.centered {  
			position:absolute;
			z-index: 100;  
			top:50%;  
			left:50%;  
			margin:-50px 0 0 -100px;  
			width:200px;  
			height:100px;  
		}  
		</style>	
		
		<script type="text/javascript">
		
			function showSection(section){
				var el = document.getElementById(section);
				el.style.display = "block";
				el.style.fontWeight = "bold";
			}
			
			function hideSection(section){
				var el = document.getElementById(section);
				el.style.display = "none";
			}
			
			function fetchData(){
					
				var params = {};
				var url = "http://localhost:8080/rest/api/2/search?jql=issueType=Bug";
//				url = url + escape("issuetype=Bug");
				
				params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.JSON;
				
				gadgets.io.makeRequest(url, response, params);
				
			}
			
			function calculateDDI(R1, R2, R3){
				var DDI = 8*R1 + 4*R2 + R3;
				return(DDI);
			}
			
			function response(obj) { 
				var jsondata = obj.data;
				var html = "";
				var R1 = 0;
				var R2 = 0;
				var R3 = 0;
				// Process returned JS object as an associative array
				for (var key in jsondata) {
					var value = jsondata[key];
					// If 'value' is an array, render its contents as a bulleted list
					if (value instanceof Array)
					{
						for (var i = 0; i < value.length ; i++)
						{
							var RPN = jsondata.issues[i].fields.customfield_10100;
							if(RPN >= 6 && RPN <= 9){
								R3++;
							}
							if(RPN >= 10 && RPN <= 17){
								R2++;
							}
							if(RPN >= 18 && RPN <= 25){
								R1++;
							}
					html += "<li>"+ JSON.stringify(jsondata.issues[i].fields.customfield_10100) + "</li>";
						}
					html+= "</ul>";
					}  
					// If 'value' isn't an array, just write it out as a string
					else {        
					
					}
				}
				html += R1 + "<br />" + R2 + "<br />" + R3;
				var DDI = calculateDDI(R1, R2, R3);
				html += DDI;
				//document.getElementById("main").appendChild(document.createElement("br"));
				var nameNode = document.createTextNode(DDI);
				document.getElementById("main").appendChild(nameNode);
				//document.getElementById('main').innerHTML = html;
				showSection('main');
				hideSection('drop-down');
			};
		
		//	gadgets.util.registerOnLoadHandler(hideSection('main'));
			gadgets.util.registerOnLoadHandler(fetchData);
			gadgets.window.adjustHeight(50);
		</script>
		
		
		
		
		
    ]]>
  </Content>
</Module>